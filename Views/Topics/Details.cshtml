@using System.Web
@model Do_An_Tot_Nghiep.Models.Topic

@{
    ViewData["Title"] = "Chi tiết chủ đề";
}

<h2 class="text-center text-primary mt-3 fw-bold animate__animated animate__fadeInDown">📄 Chi tiết chủ đề</h2>

<div class="border p-4 rounded shadow bg-white mt-4 animate__animated animate__fadeIn">
    <dl class="row">
        <dt class="col-sm-3 fw-bold text-primary">Tiêu đề:</dt>
        <dd class="col-sm-9">@Html.Raw(HttpUtility.HtmlDecode(Model.Title))</dd>

        <dt class="col-sm-3 fw-bold">Nội dung:</dt>
        <dd class="col-sm-9">@Html.Raw(HttpUtility.HtmlDecode(Model.Content))</dd>

        <dt class="col-sm-3 fw-bold">Mức hiển thị:</dt>
        <dd class="col-sm-9">
                @{
                    var type =  Model.VisibilityType?.ToLower();
                    string label = type switch
                    {
                        "public" => "Công khai",
                        "private" => "Riêng tư",
                        "group" => "Nhóm",
                        "custom" => "Tùy chọn",
                        _ => "Không rõ"
                    };
                    @label
                }
        </dd>

        <dt class="col-sm-3 fw-bold">Ngày tạo:</dt>
        <dd class="col-sm-9">@Model.CreatedAt?.ToString("dd/MM/yyyy HH:mm")</dd>

        <dt class="col-sm-3 fw-bold">Ngày cập nhật:</dt>
        <dd class="col-sm-9">@Model.UpdatedAt?.ToString("dd/MM/yyyy HH:mm")</dd>

        <dt class="col-sm-3 fw-bold">Ảnh minh họa:</dt>
        <dd class="col-sm-9">
            @if (!string.IsNullOrEmpty(Model.ImageUrl))
            {
                <img src="@Model.ImageUrl" alt="Ảnh minh họa" class="img-fluid rounded shadow-sm" style="max-width: 300px;" />
            }
            else
            {
                <span class="text-muted">Không có ảnh</span>
            }
        </dd>

        <dt class="col-sm-3 fw-bold">Tài liệu đính kèm:</dt>
        <dd class="col-sm-9">
            @if (!string.IsNullOrEmpty(Model.FileUrl))
            {
                var fileName = System.IO.Path.GetFileName(Model.FileUrl);
                <a href="@Model.FileUrl" download class="text-decoration-underline text-primary">@fileName</a>
            }
            else
            {
                <span class="text-muted">Không có tệp đính kèm</span>
            }
        </dd>
        
        <dd><strong>Thẻ:</strong>
            @if (Model.TopicTags != null && Model.TopicTags.Any())
            {
                foreach (var tag in Model.TopicTags.Select(tt => tt.Tag))
                {
                    <span class="badge bg-primary me-1">@tag.Name</span>
                }
            }
            else
            {
                <span>Không có tag</span>
            }
        </dd>
        <dt class="col-sm-3 fw-bold">Người tạo:</dt>
        <dd class="col-sm-9">@Model.User?.Username</dd>
    </dl>

    <div class="text-center mt-4 animate__animated animate__fadeInUp">
        <a asp-action="Edit" asp-route-id="@Model?.TopicId" class="btn btn-warning px-4 shadow">✏ Sửa</a>
        <a asp-action="Index" class="btn btn-secondary px-4 ms-2 shadow">🔙 Quay lại</a>
    </div>
</div>

@section Scripts {
    @await Html.PartialAsync("_ValidationScriptsPartial")
    <script src="~/js/comment.js"></script>
}

<!-- Comment form -->
<div class="comment-section mt-4">
    <h4>Bình luận (<span class="comment-count">@Model.Comments.Count</span>)</h4>
    <form asp-controller="Comments" asp-action="Create" method="post" enctype="multipart/form-data" class="comment-form">
        <input type="hidden" name="TopicId" value="@Model.TopicId" />
        <div class="form-group">
            <textarea name="Content" class="form-control" rows="3" placeholder="Viết bình luận..." required></textarea>
        </div>
        <div class="form-group mt-2">
            <input type="file" name="ImageUpload" class="form-control" accept="image/*" />
            <div class="image-preview"></div>
        </div>
        <div class="form-group mt-2">
            <button type="submit" class="btn btn-primary">Gửi bình luận</button>
        </div>
    </form>

    <!-- Comments list -->
    <div class="comments-list mt-4">
        @foreach (var comment in Model.Comments.OrderByDescending(c => c.CreatedAt))
        {
            <partial name="_CommentPartial" model="comment" />
        }
    </div>
</div>
